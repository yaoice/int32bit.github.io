---
layout: post
title: 定制k8s集群专用的虚拟机镜像
subtitle: ""
catalog: true
tags:
     - k8s
---

ubuntu系统

1. 预装chrony，/etc/rc.local中使用ntpdate同步ntp server
2. sysctl.conf加固
    ```
    # vim /etc/sysctl.conf
    kernel.core_pattern = /tmp/core-%p-%e-%t
    # 网桥iptables FORWARD生效
    net.bridge.bridge-nf-call-iptables = 1
    net.bridge.bridge-nf-call-ip6tables = 1
    # 开启 IP 转发
    net.ipv4.ip_forward = 1
    # 允许非本地址绑定
    net.ipv4.ip_nonlocal_bind=1
    # 增大socket监听队列大小
    net.core.somaxconn = 655350
    # 启用SYN Cookies
    net.ipv4.tcp_syncookies = 1
    # 增大半连接的最大数量
    net.ipv4.tcp_max_syn_backlog = 16384
    # 在NAT环境下不启用
    net.ipv4.tcp_tw_recycle = 0
    # 启用时间戳
    net.ipv4.tcp_timestamps=1
    # 允许TIME_WAIT占用的端口可以重复利用
    net.ipv4.tcp_tw_reuse = 1
    # 缩短处于TIME_WAIT状态的超时时间
    net.ipv4.tcp_fin_timeout = 30
    # 增大处于TIME_WAIT状态的连接数量
    net.ipv4.tcp_max_tw_buckets = 5000
    # 增大最大连接跟踪数
    net.netfilter.nf_conntrack_max = 2097152
    # 缩短连接跟踪表中处于TIME_WAIT状态连接的超时时间
    net.netfilter.nf_conntrack_tcp_timeout_time_wait = 30
    # 增大系统的最大文件描述符数
    fs.file-max=65535000
    # 增加进程的最大文件描述符的数量
    fs.nr_open=65535000
    ```
3. 修改ulimit
    ```
    vim /etc/security/limits.conf 
    *       hard nofile 65535000
    *       soft nofile 65535000
    *       hard nproc  65535000
    *       soft nproc 65535000
    ```
